var e=Object.defineProperty,a=Object.defineProperties,s=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(a,s,t)=>s in a?e(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t,o=(e,a)=>{for(var s in a||(a={}))l.call(a,s)&&i(e,s,a[s]);if(t)for(var s of t(a))n.call(a,s)&&i(e,s,a[s]);return e},r=(e,t)=>a(e,s(t)),c=(e,a,s)=>new Promise((t,l)=>{var n=e=>{try{o(s.next(e))}catch(a){l(a)}},i=e=>{try{o(s.throw(e))}catch(a){l(a)}},o=e=>e.done?t(e.value):Promise.resolve(e.value).then(n,i);o((s=s.apply(e,a)).next())});import{R as d,p as m,j as u,V as p,B as h,T as g,S as b,I as j,q as x,u as N,v,t as k,w as _}from"./vendors.680e87f1.js";import{u as y,C as f,a as S,A as w,s as E,g as T,b as O,c as I,d as P}from"./common.d767b0fa.js";const R=()=>{const{t:e}=y(),[a,s]=d.useState([]),[t,l]=d.useState(null),[n,i]=d.useState(""),[R,z]=d.useState([]),[C,U]=d.useState(null),[L,D]=d.useState(!1),[A,$]=d.useState(null),[B,M]=d.useState([]),[F,G]=d.useState([]),[V,q]=d.useState({customer_name:"",customer_phone:"",pet_type:"dog",pet_breed:"",pet_size:"",special_notes:""}),K=[{type:"morning",title:e("booking.morning"),start:8,end:12},{type:"afternoon",title:e("booking.afternoon"),start:12,end:18},{type:"evening",title:e("booking.evening"),start:18,end:22}],X=t&&n&&C&&V.customer_name.trim()&&V.customer_phone.trim()&&V.pet_size,[Y,H]=d.useState([]),J=()=>{const a=[],s=new Date,t=["\u65e5","\u4e00","\u4e8c","\u4e09","\u56db","\u4e94","\u516d"];for(let l=0;l<14;l++){const n=new Date(s);n.setDate(s.getDate()+l);const i=n.getMonth()+1,o=n.getDate(),r=n.getDay();let c="";c=0===l?e("booking.today"):1===l?e("booking.tomorrow"):`\u5468${t[r]}`,a.push({date:`${n.getFullYear()}-${i.toString().padStart(2,"0")}-${o.toString().padStart(2,"0")}`,month:i,day:o,week:c})}H(a)},Q=()=>c(void 0,null,function*(){try{const e=yield S({url:w.ENUMS_URL,method:"GET"});e.data.success&&(M(e.data.data.petTypes),G(e.data.data.petSizes))}catch(e){M([{value:"dog",label:"\u72d7\u72d7",icon:"/static/images/dog.png"},{value:"cat",label:"\u732b\u54aa",icon:"/static/images/cat.png"},{value:"other",label:"\u5176\u4ed6",icon:"/static/images/other.png"}]),G([{value:"small",label:"\u5c0f\u578b"},{value:"medium",label:"\u4e2d\u578b"},{value:"large",label:"\u5927\u578b"}])}}),W=()=>c(void 0,null,function*(){D(!0);try{const e=yield S({url:w.USERS_SERVICES_URL,method:"GET"});e.data.success&&s(e.data.data)}catch(a){v({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}}),Z=e=>{l(e),i(""),U(null),z([])},ee=e=>c(void 0,null,function*(){i(e),U(null),t&&(yield se(e))}),ae=e=>{U(e)},se=a=>c(void 0,null,function*(){if(t){D(!0);try{const e=t._id||t.id,s=yield S({url:w.USERS_AVAILABLE_SLOTS_URL,method:"GET",data:{date:a,serviceId:e}});s.data.success&&z(s.data.data.map(e=>r(o({},e),{available_slots:Math.floor(10*Math.random())+1})))}catch(s){v({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}}}),te=e=>{const a=K.find(a=>a.type===e);return a?R.filter(e=>{const s=parseInt(e.start_time.split(":")[0]);return s>=a.start&&s<a.end}):[]},le=()=>c(void 0,null,function*(){if(X){D(!0);try{const a=t._id||t.id,s=r(o({},V),{service_id:a,service_name:t.name,appointment_date:n,appointment_time:C.start_time,status:"pending"}),l=yield S({url:w.USERS_APPOINTMENTS_URL,method:"POST",data:s});if(l.data.success){v({title:e("booking.bookingSuccess"),icon:"success"});const a=r(o({},s),{appointment_no:l.data.data.appointment_no});E(a);const t=T(),n=yield S({url:w.USERS_GENERATE_TOKEN_URL,method:"POST",data:{phone:V.customer_phone,device_id:t}});n.data.success&&O(n.data.data.token)}else v({title:l.data.message||e("booking.bookingFailed"),icon:"error"})}catch(a){v({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}}else v({title:e("booking.completeInfo"),icon:"error"})}),ne=()=>{k.navigateTo({url:"/pages/management/management"})},ie=()=>{k.navigateTo({url:"/pages/store/store"})},oe=a=>e(`petTypes.${a}`)||a,re=a=>e(`sizes.${a}`)||a,ce=()=>{const{hasToken:e,hasAppointment:a}=I();e?a?k.redirectTo({url:"/pages/user/user?tab=profile"}):k.redirectTo({url:"/pages/user/user?tab=appointments"}):de()},de=()=>{const e=P.getToken();if(e)try{$(_(e))}catch(a){console.error("\u89e3\u6790token\u5931\u8d25:",a)}J(),Q(),W()};return d.useEffect(()=>{var e;const a=null==(e=m().router)?void 0:e.params;(null==a?void 0:a.action)?de():ce()},[]),u.jsxs(p,{className:"layout page-index",children:[u.jsx(f,{title:e("booking.title"),showBack:!1,showReports:!1,showLog:!1,personalCenter:{text:e("nav.personal"),onClick:ie}}),u.jsx(p,{className:"container",children:u.jsxs(p,{className:"content-container",children:["pet-admin"===(null==A?void 0:A.role)&&u.jsx(u.Fragment,{children:u.jsx(p,{className:"header",children:u.jsx(h,{className:"btn btn-primary",onClick:ne,children:e("nav.management")})})}),u.jsxs(p,{className:"card",children:[u.jsx(g,{className:"card-title",children:e("booking.selectService")}),u.jsx(p,{className:"service-row",children:a.map(e=>u.jsx(p,{className:"service-card "+((null==t?void 0:t._id)===e._id?"active":""),onClick:()=>Z(e),children:u.jsx(g,{className:"service-name",children:e.name})},e._id||e.id))}),t&&u.jsxs(p,{className:"service-detail",children:[u.jsxs(p,{className:"detail-header",children:[u.jsx(g,{className:"detail-name",children:t.name}),u.jsxs(g,{className:"detail-price",children:["\xa5",t.price]})]}),u.jsxs(p,{className:"detail-info",children:[u.jsxs(g,{className:"detail-duration",children:[e("booking.duration"),": ",t.duration,e("booking.minutes")]}),u.jsx(g,{className:"detail-desc",children:t.description})]})]})]}),u.jsxs(p,{className:"card",children:[u.jsx(g,{className:"card-title",children:e("booking.selectDate")}),u.jsx(b,{className:"date-scroll",scrollX:!0,children:u.jsx(p,{className:"date-row",children:Y.map(e=>u.jsxs(p,{className:"date-card "+(n===e.date?"active":""),onClick:()=>ee(e.date),children:[u.jsx(g,{className:"date-week",children:e.week}),u.jsxs(g,{className:"date-date",children:[e.month,"\u6708",e.day,"\u65e5"]})]},e.date))})})]}),R.length>0&&u.jsxs(p,{className:"card",children:[u.jsx(g,{className:"card-title",children:e("booking.selectTime")}),K.map(a=>{const s=te(a.type);return 0===s.length?null:u.jsxs(p,{className:"time-section",children:[u.jsx(g,{className:"period-title",children:a.title}),u.jsx(p,{className:"time-grid",children:s.map(a=>u.jsxs(p,{className:"time-card "+((null==C?void 0:C.start_time)===a.start_time?"active":""),onClick:()=>ae(a),children:[u.jsxs(g,{className:"time-range",children:[a.start_time," - ",a.end_time]}),u.jsxs(g,{className:"slots-available",children:[a.available_slots,e("booking.availableSlots")]})]},a.start_time))})]},a.type)})]}),u.jsxs(p,{className:"card",children:[u.jsx(g,{className:"card-title",children:e("booking.fillInfo")}),u.jsxs(p,{className:"form",children:[u.jsxs(p,{className:"form-group",children:[u.jsx(g,{className:"label",children:e("booking.customerName")}),u.jsx(j,{value:V.customer_name,placeholder:e("booking.customerName"),className:"input",onInput:e=>q(r(o({},V),{customer_name:e.detail.value}))})]}),u.jsxs(p,{className:"form-group",children:[u.jsx(g,{className:"label",children:e("booking.customerPhone")}),u.jsx(j,{value:V.customer_phone,placeholder:e("booking.customerPhone"),type:"number",maxlength:11,className:"input",onInput:e=>q(r(o({},V),{customer_phone:e.detail.value}))})]}),u.jsxs(p,{className:"form-group",children:[u.jsx(g,{className:"label",children:e("booking.petType")}),u.jsx(p,{className:"pet-type-grid",children:B.map(e=>u.jsxs(p,{className:"pet-type-card "+(V.pet_type===e.value?"active":""),onClick:()=>q(r(o({},V),{pet_type:e.value})),style:` background-image: url(${e.icon}); background-repeat: no-repeat; background-size: cover; background-position: center`,children:[u.jsx(x,{src:e.icon,className:"pet-icon",mode:"aspectFit"}),u.jsx(g,{className:"pet-type-name",children:oe(e.value)})]},e.value))})]}),u.jsxs(p,{className:"form-group",children:[u.jsx(g,{className:"label",children:e("booking.petBreed")}),u.jsx(j,{value:V.pet_breed,placeholder:e("booking.petBreed"),className:"input",onInput:e=>q(r(o({},V),{pet_breed:e.detail.value}))})]}),u.jsxs(p,{className:"form-group",children:[u.jsx(g,{className:"label",children:e("booking.petSize")}),u.jsx(p,{className:"size-grid",children:F.map(e=>u.jsx(h,{className:"size-card "+(V.pet_size===e.value?"active":""),onClick:()=>q(r(o({},V),{pet_size:e.value})),children:u.jsx(g,{className:"size-label",children:re(e.value)})},e.value))})]}),u.jsxs(p,{className:"form-group end",children:[u.jsx(g,{className:"label",children:e("booking.specialNotes")}),u.jsx(N,{id:"special_notes",value:V.special_notes,placeholder:e("booking.specialNotes"),className:"textarea",onInput:e=>q(r(o({},V),{special_notes:e.detail.value}))})]})]})]})]})}),u.jsx(p,{className:"footer",children:u.jsx(h,{onClick:le,disabled:!X,className:"submit-btn",children:e(L?"booking.submitting":"booking.submitBooking")})}),L&&u.jsx(p,{className:"loading-mask",children:u.jsx(p,{className:"loading-content",children:u.jsx(g,{children:e("common.loading")})})})]})};export{R as default};
