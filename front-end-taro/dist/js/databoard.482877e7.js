var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,o=(e,o)=>{for(var c in o||(o={}))s.call(o,c)&&n(e,c,o[c]);if(t)for(var c of t(o))a.call(o,c)&&n(e,c,o[c]);return e},c=(e,t,s)=>new Promise((a,n)=>{var o=e=>{try{l(s.next(e))}catch(t){n(t)}},c=e=>{try{l(s.throw(e))}catch(t){n(t)}},l=e=>e.done?a(e.value):Promise.resolve(e.value).then(o,c);l((s=s.apply(e,t)).next())});import{y as l,R as i,j as r,V as d,T as p,S as h}from"./vendors.5898faf2.js";import{A as m,w as u,u as b,C as x,a as N}from"./common.70eecc84.js";class j{constructor(e){this.task=null,this.options=void 0,this.reconnectAttempts=0,this.reconnectTimer=null,this.isConnected=!1,this.options=o({reconnectInterval:5e3,maxReconnectAttempts:5},e)}connect(){return c(this,null,function*(){this.task&&this.close(),this.task=yield l({url:this.options.url,header:{"content-type":"application/json"},protocols:this.options.protocols||[]}),this.task.onOpen(()=>{console.log("\u2705 WebSocket\u8fde\u63a5\u6210\u529f"),this.isConnected=!0,this.reconnectAttempts=0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.options.onOpen&&this.options.onOpen()}),this.task.onMessage(e=>{try{const t=JSON.parse(e.data);console.log("\ud83d\udce8 \u6536\u5230WebSocket\u6d88\u606f:",t),this.options.onMessage&&this.options.onMessage(t)}catch(t){console.error("\u274c \u89e3\u6790WebSocket\u6d88\u606f\u5931\u8d25:",t)}}),this.task.onClose(()=>{console.log("\ud83d\udd34 WebSocket\u8fde\u63a5\u5173\u95ed"),this.isConnected=!1,this.options.onClose&&this.options.onClose(),this.attemptReconnect()}),this.task.onError(e=>{console.error("\u274c WebSocket\u8fde\u63a5\u9519\u8bef:",e),this.isConnected=!1,this.options.onError&&this.options.onError(e),this.attemptReconnect()})})}send(e){this.isConnected&&this.task?this.task.send({data:JSON.stringify(e)}):console.warn("\u26a0\ufe0f WebSocket\u672a\u8fde\u63a5\uff0c\u65e0\u6cd5\u53d1\u9001\u6d88\u606f")}close(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.task&&(this.task.close(),this.task=null),this.isConnected=!1,this.reconnectAttempts=0}getConnectionStatus(){return this.isConnected}attemptReconnect(){this.reconnectAttempts>=this.options.maxReconnectAttempts?console.error(`\u274c \u8fbe\u5230\u6700\u5927\u91cd\u8fde\u6b21\u6570(${this.options.maxReconnectAttempts})\uff0c\u505c\u6b62\u91cd\u8fde`):this.reconnectTimer||(console.log(`\ud83d\udd04 \u5c1d\u8bd5\u91cd\u8fde... (${this.reconnectAttempts+1}/${this.options.maxReconnectAttempts})`),this.reconnectTimer=setTimeout(()=>{this.reconnectAttempts++,this.connect()},this.options.reconnectInterval))}}class y extends j{constructor(){super({url:m.WEBSOCKET_URL,protocols:["databoard-protocol"],onMessage:e=>{this.handleMessage(e)}}),this.onTodayStatsCallback=null,this.onTodayNewAppointmentsCallback=null}subscribe(){this.send({type:"subscribe"})}setOnTodayStatsCallback(e){console.log("websocket.ts -> setOnTodayStatsCallback"),this.onTodayStatsCallback=e}setOnTodayNewAppointmentsCallback(e){console.log("websocket.ts -> setOnTodayNewAppointmentsCallback"),this.onTodayNewAppointmentsCallback=e}handleMessage(e){console.log("websocket.ts -> handleMessage",e.type),"today_stats"!==e.type&&"stats_updated"!==e.type||!this.onTodayStatsCallback?"appointment_updated"===e.type&&this.onTodayNewAppointmentsCallback&&this.onTodayNewAppointmentsCallback(e.data||{}):this.onTodayStatsCallback(e.data.stats)}}new y;const k=()=>{const{t:e}=b(),[t,s]=i.useState({total:0,pending:0,confirmed:0,in_progress:0,completed:0,cancelled:0,broken:0}),[a,n]=i.useState([]),[o]=i.useState(()=>new y),l=e=>{console.log("databoard.tsx -> handleWebSocketMessage -> stats",e),s(e)},u=e=>{console.log("databoard.tsx -> handleNewAppointmentMessage -> appointment",e),n(t=>[e,...t])},j=()=>c(void 0,null,function*(){try{const e=yield N({url:m.APPOINTMENT_STATS_TODAY_URL,method:"GET"});console.log("databoard.tsx -> loadTodayStats -> response",e.data),e.data.success&&s(e.data.data)}catch(e){console.error("\u52a0\u8f7d\u4eca\u65e5\u7edf\u8ba1\u6570\u636e\u5931\u8d25:",e)}}),k=()=>c(void 0,null,function*(){try{const e=yield N({url:m.APPOINTMENT_TODAY_NEW_URL,method:"GET"});console.log("databoard.tsx -> loadTodayNewAppointments -> response",e.data),e.data.success&&n(e.data.data)}catch(e){console.error("\u52a0\u8f7d\u4eca\u65e5\u7edf\u8ba1\u6570\u636e\u5931\u8d25:",e)}});return i.useEffect(()=>(o.setOnTodayStatsCallback(l),o.setOnTodayNewAppointmentsCallback(u),o.getConnectionStatus()||(o.connect(),o.subscribe()),j(),k(),()=>{o.close()}),[]),r.jsxs(d,{className:"layout page-databoard",children:[r.jsx(x,{title:e("nav.databoard")}),r.jsx(d,{className:"container",children:r.jsxs(d,{className:"content-container",children:[r.jsxs(d,{className:"data-row card",children:[r.jsx(d,{className:"data-row-title card",children:r.jsx(p,{children:e("databoard.today_data")})}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.total")}),r.jsx(p,{className:"value",children:t.total})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.pending")}),r.jsx(p,{className:"value pending",children:t.pending})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.confirmed")}),r.jsx(p,{className:"value confirmed",children:t.confirmed})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.in_progress")}),r.jsx(p,{className:"value in-progress",children:t.in_progress})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.completed")}),r.jsx(p,{className:"value completed",children:t.completed})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.broken")}),r.jsx(p,{className:"value broken",children:t.broken})]}),r.jsxs(d,{className:"card",children:[r.jsx(p,{className:"title",children:e("databoard.cancelled")}),r.jsx(p,{className:"value cancelled",children:t.cancelled})]})]}),r.jsxs(d,{className:"appointment-list databoard",children:[r.jsx(d,{className:"appointment-list-title",children:r.jsx(p,{children:e("databoard.recent_appointments")})}),0===a.length?r.jsx(d,{className:"no-appointments",children:r.jsx(p,{children:e("databoard.no_recent_appointments")})}):r.jsx(h,{className:"appointment-scroll",scrollY:!0,children:a.map(t=>r.jsxs(d,{className:"appointment-item",children:[r.jsxs(d,{className:"appointment-header",children:[r.jsxs(p,{className:"appointment-no",children:["#",t.appointment_no]}),r.jsx(p,{className:`appointment-status ${t.status}`,children:e(`appointment_status.${t.status}`)})]}),r.jsxs(d,{className:"appointment-info",children:[r.jsx(p,{className:"customer-name",children:t.customer_name}),r.jsx(p,{className:"customer-phone",children:t.customer_phone})]}),r.jsxs(d,{className:"appointment-details",children:[r.jsx(p,{className:"service-type",children:t.service_name}),r.jsx(p,{className:"appointment-time",children:t.appointment_time})]})]},t._id))})]})]})})]})},T=u(k);export{T as default};
