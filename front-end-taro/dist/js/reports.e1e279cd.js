var e=(e,t,a)=>new Promise((r,s)=>{var l=e=>{try{i(a.next(e))}catch(t){s(t)}},n=e=>{try{i(a.throw(e))}catch(t){s(t)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,n);i((a=a.apply(e,t)).next())});import{y as t,R as a,z as r,j as s,V as l,C as n,T as i,a as o}from"./vendors.680e87f1.js";import{i as c,w as h,u as d,C as m,d as u,A as f}from"./common.d767b0fa.js";const p=({title:i,type:o,data:h})=>{const d=t().pixelRatio||1,[m,u]=a.useState({width:360*d,height:250*d}),[f,p]=a.useState(h);a.useEffect(()=>{p(h),m.width>0&&h.length>0&&setTimeout(()=>{y()},100)},[h,i,m]);const y=()=>e(void 0,null,function*(){try{const e=f;if(!e.length)return;const{width:t,height:a}=m,s=.05*t,l=s,n=.5*s,o=.8*l,c=s,h=o,d=t-2*s,u=a-l-n-2*s,p=d/e.length*.7,y=d/e.length*.3,g=Math.max(...e.map(e=>e.value))||100,v=s,j=a-s,S=s,b=l+s+n,w=t-y/2,T=a-s,N=r("barChart");N.clearRect(0,0,d,u),N.setStrokeStyle("#333"),N.setLineWidth(1),N.beginPath(),N.moveTo(S,b),N.lineTo(v,j),N.lineTo(w,T),N.stroke();const k=u/g;e.forEach((e,t)=>{const r=s+t*(p+y)+y/2,l=k*e.value,n=a-s-l,i=["#4cd964","#007aff","#e62020ff","#ffcc00","#8e8e93","#ff9500"],o=i[t%i.length];N.setFillStyle(o),N.fillRect(r,n,p,l),N.setFillStyle("#000"),N.setTextAlign("center"),N.fillText(e.value.toString(),r+p/2,n-5),N.fillText(e.name,r+p/2,a-s+h)});x(i,o);N.setFillStyle("#000 bold"),N.setFontSize(o),N.setTextAlign("center"),N.fillText(i,t/2,c),N.draw()}catch(e){console.error("\u7ed8\u5236\u67f1\u72b6\u56fe\u5931\u8d25:",e)}}),x=(e,t)=>{let a=0;for(let r of e)a+=c(r)?t:t/2;return a};return s.jsx(l,{className:"chart-container",children:s.jsx(n,{id:"barChart",canvasId:"barChart",width:m.width,height:m.height,style:{width:"auto",height:"100%",aspectRatio:m.width/m.height}})})},y=({title:i,data:o,width:h=360,height:d=250})=>{const m=t().pixelRatio||2,[u,f]=a.useState({width:360*m,height:250*m}),p=()=>e(void 0,null,function*(){try{if(!o.length)return;const{width:e,height:t}=u,a=e,s=t,l=o.reduce((e,t)=>e+t.value,0);if(0===l)return;const n=.05*e,c=y(i,n),h=s/2,d=s/2+n,m=Math.min(h,d)-n;let f=0;const p=["#4cd964","#007aff","#e62020ff","#ffcc00","#8e8e93","#ff9500"],v=r("pieChart",void 0);v.clearRect(0,0,a,s),o.forEach((e,t)=>{const a=e.value/l*2*Math.PI,r=p[t%p.length];v.beginPath(),v.moveTo(h,d),v.arc(h,d,m,f,f+a),v.closePath(),v.setFillStyle(r),v.fill(),v.setStrokeStyle("#fff"),v.setLineWidth(3),v.stroke();const s=f+a/2,n=.6*m,i=h+Math.cos(s)*n-20,o=d+Math.sin(s)*n,c=(e.value/l*100).toFixed(1),u=x(r);v.setFillStyle(u),v.setTextAlign("center"),v.setTextBaseline("middle"),a>.3&&v.fillText(`${c}%`,i,o),f+=a}),v.setFillStyle("#000"),v.setFontSize(n),v.setTextAlign("center"),v.fillText(i,e/2-c/2,n/2),g(v,o,l,p,a),v.draw()}catch(e){console.error("\u7ed8\u5236\u997c\u56fe\u5931\u8d25:",e)}}),y=(e,t)=>{let a=0;for(let r of e)a+=c(r)?t:t/2;return a},x=e=>{const t=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16),s=(299*t+587*a+114*r)/1e3;return s>128?"#333333":"#ffffff"},g=(e,t,a,r,s)=>{const l=50,n=.04*s,i=Math.max(...t.map(e=>e.name.length+(e.value+"").length)),o=t.find(e=>e.name.length+(e.value+"").length===i).name,c=y(o+"aaaa",n),h=s-c-n;t.forEach((t,s)=>{const i=1.5*n,o=l+s*i,c=r[s%r.length],d=(t.value/a*100).toFixed(1);e.setFillStyle(c),e.fillRect(h,o,i,i),e.setFillStyle("#333"),e.setFontSize(n),e.setTextAlign("left");let m=`${t.name} (${t.value})`;m.length>15&&(m=t.name.substring(0,8)+`...(${d}%)`),e.fillText(m,h+i,o+i/2)})};return a.useEffect(()=>{setTimeout(()=>{p()},100)},[o,i]),s.jsx(l,{className:"chart-container",style:{aspectRatio:u.width/u.height},children:s.jsx(n,{id:"pieChart",canvasId:"pieChart",width:u.width,height:u.height,style:{display:"flex",width:"auto",height:"100%",aspectRatio:u.width/u.height}})})},x=()=>{const{t:t}=d(),[r,n]=a.useState("day"),[c,h]=a.useState([]),[x,g]=a.useState([]),[v,j]=a.useState(!1),[S,b]=a.useState(""),w=a=>e(void 0,null,function*(){j(!0),b("");try{let e="";switch(a){case"day":e="daily";break;case"month":e="monthly";break;case"year":e="yearly";break;default:e="daily"}const r=u.getToken();if(!r)return void b(t("common.networkError")||"\u8bf7\u5148\u767b\u5f55");const s=yield o({url:f.REPORTS_BASE_URL+e,method:"GET",header:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(s.data.success){const e=s.data.data;T(e,a)}else b(t("reports.error")||"\u52a0\u8f7d\u5931\u8d25")}catch(e){b(t("reports.error")||"\u52a0\u8f7d\u5931\u8d25")}finally{j(!1)}}),T=(e,a)=>{const r=[{name:t("reports.completed"),value:e.reduce((e,t)=>e+(t.completed||0),0)},{name:t("reports.broken"),value:e.reduce((e,t)=>e+(t.broken||0),0)},{name:t("reports.canceled"),value:e.reduce((e,t)=>e+(t.canceled||0),0)}];h(r),console.log("reports.tsx -> processChartData -> pieChartData",t("reports.completed"));const s=e.map(e=>{let t="";switch(a){case"day":t=e.date.split("-").slice(1)[1];break;case"month":t=N(e.month.split("-")[1]);break;case"year":t=e.year;break;default:t=e.date}return{name:t,value:e.total||0}}),l="month"===a?s.filter(e=>parseInt(e.name)<=(new Date).getMonth()+1):s;g(l)},N=e=>{const a=[t("reports.january"),t("reports.february"),t("reports.march"),t("reports.april"),t("reports.may"),t("reports.june"),t("reports.july"),t("reports.august"),t("reports.september"),t("reports.october"),t("reports.november"),t("reports.december")];return a[parseInt(e)-1]||e},k=e=>{n(e)};a.useEffect(()=>{w(r)},[r]);const C=()=>{switch(r){case"day":return t("reports.dailyStats");case"month":return t("reports.monthlyStats");case"year":return(new Date).toLocaleString("default",{year:"numeric"})+" "+t("reports.yearlyStats");default:return t("reports.barChartTitle")}};return s.jsxs(l,{className:"layout page-reports",children:[s.jsx(m,{title:t("reports.title")}),s.jsx(l,{className:"container",children:s.jsxs(l,{className:"content-container",children:[v&&s.jsx(l,{className:"loading-container",children:s.jsx(i,{className:"loading-text",children:t("reports.loading")})}),S&&!v&&s.jsx(l,{className:"error-container",children:s.jsx(i,{className:"error-text",children:S})}),!v&&!S&&s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"charts-box card",children:s.jsx(y,{title:t("reports.pieChartTitle"),data:c.length>0?c:[{name:t("reports.completed"),value:0},{name:t("reports.broken"),value:0}]})}),s.jsx(l,{className:"charts-box card",children:s.jsx(p,{title:C(),data:x,type:r})})]}),s.jsx(l,{className:"filter-bar",children:s.jsxs(l,{className:"filter-item-box card",children:[s.jsx(l,{className:"filter-item day "+("day"===r?"active":""),onClick:()=>k("day"),children:t("reports.day")}),s.jsx(l,{className:"filter-item-divide"}),s.jsx(l,{className:"filter-item month "+("month"===r?"active":""),onClick:()=>k("month"),children:t("reports.month")}),s.jsx(l,{className:"filter-item-divide"}),s.jsx(l,{className:"filter-item year "+("year"===r?"active":""),onClick:()=>k("year"),children:t("reports.year")})]})}),!v&&!S&&0===c.length&&0===x.length&&s.jsx(l,{className:"no-data-container",children:s.jsx(i,{className:"no-data-text",children:t("reports.noData")})})]})})]})},g=h(x);export{g as default};
