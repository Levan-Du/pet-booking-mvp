var e=(e,t,a)=>new Promise((s,r)=>{var l=e=>{try{i(a.next(e))}catch(t){r(t)}},n=e=>{try{i(a.throw(e))}catch(t){r(t)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(l,n);i((a=a.apply(e,t)).next())});import{z as t,R as a,A as s,j as r,V as l,C as n,T as i,a as o}from"./vendors.5898faf2.js";import{i as c,w as h,u as d,C as m,d as f,A as u}from"./common.70eecc84.js";const p=({title:i,type:o,data:h})=>{const d=t().pixelRatio||1,[m,f]=a.useState({width:360*d,height:250*d}),[u,p]=a.useState(h);a.useEffect(()=>{console.log("simple-bar-chart -> useEffect -> data",h),p(h),m.width>0&&h.length>0&&setTimeout(()=>{x()},100)},[h,i,m]);const x=()=>e(void 0,null,function*(){try{const e=u;if(!e.length)return;const{width:t,height:a}=m,r=.05*t,l=r,n=.5*r,o=.8*l,c=r,h=o,d=t-2*r,f=a-l-n-2*r,p=d/e.length*.7,x=d/e.length*.3,y=Math.max(...e.map(e=>e.value))||100,v=r,S=a-r,j=r,w=l+r+n,T=t-x/2,b=a-r,N=s("barChart");N.clearRect(0,0,d,f),N.setStrokeStyle("#333"),N.setLineWidth(1),N.beginPath(),N.moveTo(j,w),N.lineTo(v,S),N.lineTo(T,b),N.stroke();const k=f/y;e.forEach((e,t)=>{const s=r+t*(p+x)+x/2,l=k*e.value,n=a-r-l,i=["#4cd964","#007aff","#e62020ff","#ffcc00","#8e8e93","#ff9500"],o=i[t%i.length];N.setFillStyle(o),N.fillRect(s,n,p,l),N.setFillStyle("#000"),N.setTextAlign("center"),N.fillText(e.value.toString(),s+p/2,n-5),N.fillText(e.name,s+p/2,a-r+h)});g(i,o);N.setFillStyle("#000 bold"),N.setFontSize(o),N.setTextAlign("center"),N.fillText(i,t/2,c),N.draw()}catch(e){console.error("\u7ed8\u5236\u67f1\u72b6\u56fe\u5931\u8d25:",e)}}),g=(e,t)=>{let a=0;for(let s of e)a+=c(s)?t:t/2;return a};return r.jsx(l,{className:"chart-container",children:r.jsx(n,{id:"barChart",canvasId:"barChart",width:m.width,height:m.height,style:{width:"auto",height:"100%",aspectRatio:m.width/m.height}})})},x=({title:i,data:o})=>{const h=t().pixelRatio||2,[d,m]=a.useState({width:360*h,height:250*h}),f=()=>e(void 0,null,function*(){try{if(!o.length)return;const{width:e,height:t}=d,a=e,r=t,l=o.reduce((e,t)=>e+t.value,0);if(0===l)return;const n=.05*e,c=u(i,n),h=r/2,m=r/2+n,f=Math.min(h,m)-n;let g=0;const y=["#4cd964","#007aff","#e62020ff","#ffcc00","#8e8e93","#ff9500"],v=s("pieChart",void 0);v.clearRect(0,0,a,r),o.forEach((e,t)=>{const a=e.value/l*2*Math.PI,s=y[t%y.length];v.beginPath(),v.moveTo(h,m),v.arc(h,m,f,g,g+a),v.closePath(),v.setFillStyle(s),v.fill(),v.setStrokeStyle("#fff"),v.setLineWidth(3),v.stroke();const r=g+a/2,n=.6*f,i=h+Math.cos(r)*n-20,o=m+Math.sin(r)*n,c=(e.value/l*100).toFixed(1),d=p(s);v.setFillStyle(d),v.setTextAlign("center"),v.setTextBaseline("middle"),a>.3&&v.fillText(`${c}%`,i,o),g+=a}),v.setFillStyle("#000"),v.setFontSize(n),v.setTextAlign("center"),v.fillText(i,e/2-c/2,n/2),x(v,o,l,y,a),v.draw()}catch(e){console.error("\u7ed8\u5236\u997c\u56fe\u5931\u8d25:",e)}}),u=(e,t)=>{let a=0;for(let s of e)a+=c(s)?t:t/2;return a},p=e=>{const t=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16),r=(299*t+587*a+114*s)/1e3;return r>128?"#333333":"#ffffff"},x=(e,t,a,s,r)=>{const l=50,n=.04*r,i=Math.max(...t.map(e=>e.name.length+(e.value+"").length)),o=t.find(e=>e.name.length+(e.value+"").length===i).name,c=u(o+"aaaa",n),h=r-c-n;console.log("simple-pie-chart.tsx -> maxLengthName,fontLineWidth,legendX",o,c,h),t.forEach((t,r)=>{const i=l+r*n,o=s[r%s.length],c=(t.value/a*100).toFixed(1);e.setFillStyle(o),e.fillRect(h,i,n,n),e.setFillStyle("#333"),e.setFontSize(n),e.setTextAlign("left");let d=`${t.name} (${t.value})`;d.length>15&&(d=t.name.substring(0,8)+`...(${c}%)`),e.fillText(d,h+n,i+n/2)})};return a.useEffect(()=>{setTimeout(()=>{f()},100)},[o,i]),r.jsx(l,{className:"chart-container",style:{aspectRatio:d.width/d.height},children:r.jsx(n,{id:"pieChart",canvasId:"pieChart",width:d.width,height:d.height,style:{display:"flex",width:"auto",height:"100%",aspectRatio:d.width/d.height}})})},g=()=>{const{t:t}=d(),[s,n]=a.useState("day"),[c,h]=a.useState([]),[g,y]=a.useState([]),[v,S]=a.useState(!1),[j,w]=a.useState(""),T=a=>e(void 0,null,function*(){S(!0),w("");try{let e="";switch(a){case"day":e="daily";break;case"month":e="monthly";break;case"year":e="yearly";break;default:e="daily"}const s=f.getToken();if(!s)return void w(t("common.networkError")||"\u8bf7\u5148\u767b\u5f55");const r=yield o({url:u.REPORTS_BASE_URL+e,method:"GET",header:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},data:{pageSize:10}});if(console.log("reports.tsx -> fetchReportData -> response",r),r.data.success){const e=r.data.data;b(e,a)}else w(t("reports.error")||"\u52a0\u8f7d\u5931\u8d25")}catch(e){console.error("\u83b7\u53d6\u62a5\u8868\u6570\u636e\u9519\u8bef:",e),w(t("reports.error")||"\u52a0\u8f7d\u5931\u8d25")}finally{S(!1)}}),b=(e,a)=>{const s=[{name:t("reports.completed"),value:e.reduce((e,t)=>e+(t.completed||0),0)},{name:t("reports.broken"),value:e.reduce((e,t)=>e+(t.broken||0),0)},{name:t("reports.canceled"),value:e.reduce((e,t)=>e+(t.canceled||0),0)}];h(s),console.log("reports.tsx -> processChartData -> pieChartData",c);const r=e.map(e=>{let t="";switch(a){case"day":t=e.date.split("-").slice(1)[1];break;case"month":t=N(e.month.split("-")[1]);break;case"year":t=e.year;break;default:t=e.date}return{name:t,value:e.total||0}}),l="month"===a?r.filter(e=>parseInt(e.name)<=(new Date).getMonth()+1):r;y(l),console.log("reports.tsx -> processChartData -> barChartData",g)},N=e=>e,k=e=>{n(e)};a.useEffect(()=>{console.log("reports.tsx -> useEffect -> selectedFilter",s),T(s)},[s]);const C=()=>{switch(s){case"day":return t("reports.dailyStats");case"month":return t("reports.monthlyStats");case"year":return(new Date).toLocaleString("default",{year:"numeric"})+" "+t("reports.yearlyStats");default:return t("reports.barChartTitle")}};return r.jsxs(l,{className:"layout page-reports",children:[r.jsx(m,{title:t("reports.title")}),r.jsx(l,{className:"container",children:r.jsxs(l,{className:"content-container",children:[v&&r.jsx(l,{className:"loading-container",children:r.jsx(i,{className:"loading-text",children:t("reports.loading")})}),j&&!v&&r.jsx(l,{className:"error-container",children:r.jsx(i,{className:"error-text",children:j})}),!v&&!j&&r.jsxs(r.Fragment,{children:[r.jsx(l,{className:"charts-box card",children:r.jsx(x,{title:t("reports.pieChartTitle"),data:c.length>0?c:[{name:t("reports.completed"),value:0},{name:t("reports.broken"),value:0}]})}),r.jsx(l,{className:"charts-box card",children:r.jsx(p,{title:C(),data:g,type:s})})]}),r.jsx(l,{className:"filter-bar",children:r.jsxs(l,{className:"filter-item-box card",children:[r.jsx(l,{className:"filter-item day "+("day"===s?"active":""),onClick:()=>k("day"),children:t("reports.day")}),r.jsx(l,{className:"filter-item-divide"}),r.jsx(l,{className:"filter-item month "+("month"===s?"active":""),onClick:()=>k("month"),children:t("reports.month")}),r.jsx(l,{className:"filter-item-divide"}),r.jsx(l,{className:"filter-item year "+("year"===s?"active":""),onClick:()=>k("year"),children:t("reports.year")})]})}),!v&&!j&&0===c.length&&0===g.length&&r.jsx(l,{className:"no-data-container",children:r.jsx(i,{className:"no-data-text",children:t("reports.noData")})})]})})]})},y=h(g);export{y as default};
