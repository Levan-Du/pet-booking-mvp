var e=Object.defineProperty,a=Object.defineProperties,s=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(a,s,t)=>s in a?e(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t,i=(e,a)=>{for(var s in a||(a={}))l.call(a,s)&&o(e,s,a[s]);if(t)for(var s of t(a))n.call(a,s)&&o(e,s,a[s]);return e},r=(e,t)=>a(e,s(t)),c=(e,a,s)=>new Promise((t,l)=>{var n=e=>{try{i(s.next(e))}catch(a){l(a)}},o=e=>{try{i(s.throw(e))}catch(a){l(a)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(n,o);i((s=s.apply(e,a)).next())});import{R as d,t as m,p as u,j as p,V as h,B as g,T as b,S as x,I as j,q as N,u as v,v as k,w as _}from"./vendors.680e87f1.js";import{u as y,C as f,a as S,A as T,s as w,g as E,b as I,c as O,d as P}from"./common.91e146f8.js";const R=()=>{const{t:e}=y(),[a,s]=d.useState([]),[t,l]=d.useState(null),[n,o]=d.useState(""),[R,z]=d.useState([]),[C,U]=d.useState(null),[L,D]=d.useState(!1),[A,B]=d.useState(null),[$,M]=d.useState([]),[F,G]=d.useState([]),[V,q]=d.useState({customer_name:"",customer_phone:"",pet_type:"dog",pet_breed:"",pet_size:"",special_notes:""}),K=[{type:"morning",title:e("booking.morning"),start:8,end:12},{type:"afternoon",title:e("booking.afternoon"),start:12,end:18},{type:"evening",title:e("booking.evening"),start:18,end:22}],X=t&&n&&C&&V.customer_name.trim()&&V.customer_phone.trim()&&V.pet_size,[Y,H]=d.useState([]),J=()=>{const a=[],s=new Date,t=["\u65e5","\u4e00","\u4e8c","\u4e09","\u56db","\u4e94","\u516d"];for(let l=0;l<14;l++){const n=new Date(s);n.setDate(s.getDate()+l);const o=n.getMonth()+1,i=n.getDate(),r=n.getDay();let c="";c=0===l?e("booking.today"):1===l?e("booking.tomorrow"):`\u5468${t[r]}`,a.push({date:`${n.getFullYear()}-${o.toString().padStart(2,"0")}-${i.toString().padStart(2,"0")}`,month:o,day:i,week:c})}H(a)},Q=()=>c(void 0,null,function*(){try{const e=yield S({url:T.ENUMS_URL,method:"GET"});e.data.success&&(M(e.data.data.petTypes),G(e.data.data.petSizes))}catch(e){M([{value:"dog",label:"\u72d7\u72d7",icon:"/static/images/dog.png"},{value:"cat",label:"\u732b\u54aa",icon:"/static/images/cat.png"},{value:"other",label:"\u5176\u4ed6",icon:"/static/images/other.png"}]),G([{value:"small",label:"\u5c0f\u578b"},{value:"medium",label:"\u4e2d\u578b"},{value:"large",label:"\u5927\u578b"}])}}),W=()=>c(void 0,null,function*(){D(!0);try{const e=yield S({url:T.USERS_SERVICES_URL,method:"GET"});e.data.success&&s(e.data.data)}catch(a){k({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}});m.useReady(()=>{console.log("Page loaded.")});const Z=e=>{l(e),o(""),U(null),z([])},ee=e=>c(void 0,null,function*(){o(e),U(null),t&&(yield se(e))}),ae=e=>{U(e)},se=a=>c(void 0,null,function*(){if(t){D(!0);try{const e=t._id||t.id;console.log("index.tsx -> loadTimeSlots -> serviceId",e);const s=yield S({url:T.USERS_AVAILABLE_SLOTS_URL,method:"GET",data:{date:a,serviceId:e}});s.data.success&&z(s.data.data.map(e=>r(i({},e),{available_slots:Math.floor(10*Math.random())+1})))}catch(s){k({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}}}),te=e=>{const a=K.find(a=>a.type===e);return a?R.filter(e=>{const s=parseInt(e.start_time.split(":")[0]);return s>=a.start&&s<a.end}):[]},le=()=>c(void 0,null,function*(){if(X){D(!0);try{const a=t._id||t.id,s=r(i({},V),{service_id:a,service_name:t.name,appointment_date:n,appointment_time:C.start_time,status:"pending"}),l=yield S({url:T.USERS_APPOINTMENTS_URL,method:"POST",data:s});if(console.log("index.tsx -> submitBooking -> response",l),l.data.success){k({title:e("booking.bookingSuccess"),icon:"success"});const a=r(i({},s),{appointment_no:l.data.data.appointment_no});w(a);const t=E(),n=yield S({url:T.USERS_GENERATE_TOKEN_URL,method:"POST",data:{phone:V.customer_phone,device_id:t}});n.data.success&&I(n.data.data.token)}else k({title:l.data.message||e("booking.bookingFailed"),icon:"error"})}catch(a){k({title:e("errors.networkError"),icon:"error"})}finally{D(!1)}}else k({title:e("booking.completeInfo"),icon:"error"})}),ne=()=>{m.navigateTo({url:"/pages/management/management"})},oe=()=>{m.navigateTo({url:"/pages/store/store"})},ie=a=>e(`petTypes.${a}`)||a,re=a=>e(`sizes.${a}`)||a,ce=()=>{const{hasToken:e,hasAppointment:a}=O();e?a?m.redirectTo({url:"/pages/user/user?tab=profile"}):m.redirectTo({url:"/pages/user/user?tab=appointments"}):de()},de=()=>{const e=P.getToken();if(e)try{B(_(e))}catch(a){console.error("\u89e3\u6790token\u5931\u8d25:",a)}J(),Q(),W()};return d.useEffect(()=>{var e;const a=null==(e=u().router)?void 0:e.params;(null==a?void 0:a.action)?de():ce()},[]),p.jsxs(h,{className:"layout page-index",children:[p.jsx(f,{title:e("booking.title"),showBack:!1,showReports:!1,showLog:!1,personalCenter:{text:e("nav.personal"),onClick:oe}}),p.jsx(h,{className:"container",children:p.jsxs(h,{className:"content-container",children:["pet-admin"===(null==A?void 0:A.role)&&p.jsx(p.Fragment,{children:p.jsx(h,{className:"header",children:p.jsx(g,{className:"btn btn-primary",onClick:ne,children:e("nav.management")})})}),p.jsxs(h,{className:"card",children:[p.jsx(b,{className:"card-title",children:e("booking.selectService")}),p.jsx(h,{className:"service-row",children:a.map(e=>p.jsx(h,{className:"service-card "+((null==t?void 0:t._id)===e._id?"active":""),onClick:()=>Z(e),children:p.jsx(b,{className:"service-name",children:e.name})},e._id||e.id))}),t&&p.jsxs(h,{className:"service-detail",children:[p.jsxs(h,{className:"detail-header",children:[p.jsx(b,{className:"detail-name",children:t.name}),p.jsxs(b,{className:"detail-price",children:["\xa5",t.price]})]}),p.jsxs(h,{className:"detail-info",children:[p.jsxs(b,{className:"detail-duration",children:[e("booking.duration"),": ",t.duration,e("booking.minutes")]}),p.jsx(b,{className:"detail-desc",children:t.description})]})]})]}),p.jsxs(h,{className:"card",children:[p.jsx(b,{className:"card-title",children:e("booking.selectDate")}),p.jsx(x,{className:"date-scroll",scrollX:!0,children:p.jsx(h,{className:"date-row",children:Y.map(e=>p.jsxs(h,{className:"date-card "+(n===e.date?"active":""),onClick:()=>ee(e.date),children:[p.jsx(b,{className:"date-week",children:e.week}),p.jsxs(b,{className:"date-date",children:[e.month,"\u6708",e.day,"\u65e5"]})]},e.date))})})]}),R.length>0&&p.jsxs(h,{className:"card",children:[p.jsx(b,{className:"card-title",children:e("booking.selectTime")}),K.map(a=>{const s=te(a.type);return 0===s.length?null:p.jsxs(h,{className:"time-section",children:[p.jsx(b,{className:"period-title",children:a.title}),p.jsx(h,{className:"time-grid",children:s.map(a=>p.jsxs(h,{className:"time-card "+((null==C?void 0:C.start_time)===a.start_time?"active":""),onClick:()=>ae(a),children:[p.jsxs(b,{className:"time-range",children:[a.start_time," - ",a.end_time]}),p.jsxs(b,{className:"slots-available",children:[a.available_slots,e("booking.availableSlots")]})]},a.start_time))})]},a.type)})]}),p.jsxs(h,{className:"card",children:[p.jsx(b,{className:"card-title",children:e("booking.fillInfo")}),p.jsxs(h,{className:"form",children:[p.jsxs(h,{className:"form-group",children:[p.jsx(b,{className:"label",children:e("booking.customerName")}),p.jsx(j,{value:V.customer_name,placeholder:e("booking.customerName"),className:"input",onInput:e=>q(r(i({},V),{customer_name:e.detail.value}))})]}),p.jsxs(h,{className:"form-group",children:[p.jsx(b,{className:"label",children:e("booking.customerPhone")}),p.jsx(j,{value:V.customer_phone,placeholder:e("booking.customerPhone"),type:"number",maxlength:11,className:"input",onInput:e=>q(r(i({},V),{customer_phone:e.detail.value}))})]}),p.jsxs(h,{className:"form-group",children:[p.jsx(b,{className:"label",children:e("booking.petType")}),p.jsx(h,{className:"pet-type-grid",children:$.map(e=>p.jsxs(h,{className:"pet-type-card "+(V.pet_type===e.value?"active":""),onClick:()=>q(r(i({},V),{pet_type:e.value})),style:` background-image: url(${e.icon}); background-repeat: no-repeat; background-size: cover; background-position: center`,children:[p.jsx(N,{src:e.icon,className:"pet-icon",mode:"aspectFit"}),p.jsx(b,{className:"pet-type-name",children:ie(e.value)})]},e.value))})]}),p.jsxs(h,{className:"form-group",children:[p.jsx(b,{className:"label",children:e("booking.petBreed")}),p.jsx(j,{value:V.pet_breed,placeholder:e("booking.petBreed"),className:"input",onInput:e=>q(r(i({},V),{pet_breed:e.detail.value}))})]}),p.jsxs(h,{className:"form-group",children:[p.jsx(b,{className:"label",children:e("booking.petSize")}),p.jsx(h,{className:"size-grid",children:F.map(e=>p.jsx(g,{className:"size-card "+(V.pet_size===e.value?"active":""),onClick:()=>q(r(i({},V),{pet_size:e.value})),children:p.jsx(b,{className:"size-label",children:re(e.value)})},e.value))})]}),p.jsxs(h,{className:"form-group end",children:[p.jsx(b,{className:"label",children:e("booking.specialNotes")}),p.jsx(v,{id:"special_notes",value:V.special_notes,placeholder:e("booking.specialNotes"),className:"textarea",onInput:e=>q(r(i({},V),{special_notes:e.detail.value}))})]})]})]})]})}),p.jsx(h,{className:"footer",children:p.jsx(g,{onClick:le,disabled:!X,className:"submit-btn",children:e(L?"booking.submitting":"booking.submitBooking")})}),L&&p.jsx(h,{className:"loading-mask",children:p.jsx(h,{className:"loading-content",children:p.jsx(b,{children:e("common.loading")})})})]})};export{R as default};
