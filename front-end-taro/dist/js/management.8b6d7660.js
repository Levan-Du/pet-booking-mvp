var e=(e,a,n)=>new Promise((t,s)=>{var c=e=>{try{r(n.next(e))}catch(a){s(a)}},l=e=>{try{r(n.throw(e))}catch(a){s(a)}},r=e=>e.done?t(e.value):Promise.resolve(e.value).then(c,l);r((n=n.apply(e,a)).next())});import{j as a,V as n,T as t,B as s,x as c,v as l,c as r,S as o,R as m}from"./vendors.680e87f1.js";import{u as i,w as d,a as u,A as h,C as x,f as g}from"./common.41b60135.js";const j=({onScanSuccess:r,onClose:o})=>{const{t:m}=i(),d=()=>e(void 0,null,function*(){try{const e=yield c({scanType:["qrCode"],onlyFromCamera:!0});e.result&&r(e.result)}catch(e){l({title:m("common.scanFailed")||"\u626b\u7801\u5931\u8d25",icon:"error"})}});return a.jsx(n,{className:"qr-scanner",children:a.jsx(n,{className:"scanner-overlay",children:a.jsxs(n,{className:"scanner-content",children:[a.jsx(t,{className:"scanner-title",children:m("management.scan_qr")||"\u626b\u7801\u7b7e\u5230"}),a.jsx(t,{className:"scanner-desc",children:"\u8bf7\u5bf9\u51c6\u5ba2\u6237\u7684\u9884\u7ea6\u4e8c\u7ef4\u7801\u8fdb\u884c\u626b\u63cf"}),a.jsx(s,{className:"scan-button",onClick:d,children:m("management.scan_qr")||"\u5f00\u59cb\u626b\u7801"}),a.jsx(s,{className:"close-button",onClick:o,children:m("common.close")||"\u5173\u95ed"})]})})})},p=({visible:e,onClose:c,onConfirm:m,initialStartDate:d="",initialEndDate:u=""})=>{const{t:h}=i(),[x,g]=r.useState(new Date),[j,p]=r.useState(d),[N,v]=r.useState(u),[D,b]=r.useState(!0),f=r.useRef(null),_=e=>{const a=e.getFullYear(),n=e.getMonth(),t=new Date(a,n,1),s=new Date(a,n+1,0),c=t.getDay(),l=[],r=new Date(a,n,0).getDate();for(let i=c-1;i>=0;i--)l.push(new Date(a,n-1,r-i));for(let i=1;i<=s.getDate();i++)l.push(new Date(a,n,i));const o=42,m=o-l.length;for(let i=1;i<=m;i++)l.push(new Date(a,n+1,i));return l},y=e=>{const a=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0");return`${a}-${n}-${t}`},k=e=>{if(!j||!N)return!1;const a=y(e),n=new Date(j),t=new Date(N),s=new Date(a);return s>=n&&s<=t},S=e=>{const a=y(e);D?(p(a),v(""),b(!1)):(new Date(a)<new Date(j)?(v(j),p(a)):v(a),b(!0))},w=()=>{g(new Date(x.getFullYear(),x.getMonth()-1,1))},C=()=>{g(new Date(x.getFullYear(),x.getMonth()+1,1))},$=()=>{j&&N?(m(j,N),c()):l({title:h("management.selectDateRange"),icon:"none"})},T=()=>{p(""),v(""),b(!0)};if(!e)return null;const E=_(x),P=[h("common.sunday"),h("common.monday"),h("common.tuesday"),h("common.wednesday"),h("common.thursday"),h("common.friday"),h("common.saturday")],F=[h("common.january"),h("common.february"),h("common.march"),h("common.april"),h("common.may"),h("common.june"),h("common.july"),h("common.august"),h("common.september"),h("common.october"),h("common.november"),h("common.december")];return a.jsxs(n,{className:"date-range-picker-modal",children:[a.jsx(n,{className:"date-range-picker-overlay",onClick:c}),a.jsxs(n,{className:"date-range-picker-content",children:[a.jsxs(n,{className:"picker-header",children:[a.jsx(t,{className:"picker-title",children:h("management.selectDateRange")}),a.jsxs(n,{className:"month-navigation",children:[a.jsx(t,{className:"nav-btn",onClick:w,children:"\u2039"}),a.jsxs(t,{className:"month-title",children:[x.getFullYear(),h("common.year"),F[x.getMonth()]]}),a.jsx(t,{className:"nav-btn",onClick:C,children:"\u203a"})]}),a.jsx(n,{className:"selection-info",children:a.jsx(t,{className:"info-text",children:j&&N?`${j} ${h("common.to")} ${N}`:h(D?"management.selectStartDate":"management.selectEndDate")})})]}),a.jsx(n,{className:"week-days",children:P.map(e=>a.jsx(t,{className:"week-day",children:e},e))}),a.jsx(o,{className:"calendar-scroll",scrollX:!0,ref:f,children:a.jsx(n,{className:"calendar-grid",children:E.map((e,s)=>{const c=y(e),l=e.getMonth()===x.getMonth(),r=c===y(new Date),o=c===j,m=c===N,i=k(e);return a.jsx(n,{className:`date-cell ${l?"current-month":"other-month"} ${r?"today":""} ${o?"selected-start":""} ${m?"selected-end":""} ${i?"in-range":""}`,onClick:()=>S(e),children:a.jsx(t,{className:"date-text",children:e.getDate()})},s)})})}),a.jsxs(n,{className:"picker-actions",children:[a.jsx(s,{className:"action-btn clear-btn",onClick:T,children:h("management.clear")}),a.jsx(s,{className:"action-btn confirm-btn",onClick:$,children:h("common.confirm")})]})]})]})},N=()=>{const{t:c}=i(),r=[{value:"all",label:c("management.allStatus"),active:!0},{value:"pending",label:c("management.pending"),active:!0},{value:"confirmed",label:c("management.confirmed"),active:!0},{value:"in_progress",label:c("management.in_progress"),active:!0},{value:"completed",label:c("management.completed"),active:!0},{value:"cancelled",label:c("management.cancelled"),active:!0},{value:"broken",label:c("management.broken"),active:!0}],[d,N]=m.useState([]),[v,D]=m.useState(!1),[b,f]=m.useState(r[0]),[_,y]=m.useState(0),[k,S]=m.useState({startDate:"",endDate:""}),[w,C]=m.useState(!1),[$,T]=m.useState(!1),[E,P]=m.useState(!1),[F,M]=m.useState("");console.log("management.tsx -> 11111"),m.useEffect(()=>{R()},[]),m.useEffect(()=>{R()},[_,k]);const R=()=>e(void 0,null,function*(){D(!0);try{const e={};"all"!==b.value&&(e.status=b.value),k.startDate&&k.endDate&&(e.startDate=k.startDate,e.endDate=k.endDate);const a=yield u({url:h.APPOINTMENTS_URL,method:"GET",data:e});console.log("management.tsx -> loadAppointments -> response",a),a.data.success&&N(a.data.data)}catch(e){l({title:c("management.loadFailed"),icon:"error"})}finally{D(!1)}}),A=(a,n,t="update_status")=>e(void 0,null,function*(){try{const e=yield u({url:`${h.APPOINTMENTS_UPDATE_STATUS_URL.replace(":id",a)}`,method:"PUT",data:{status:n}});e.data.success?(yield u({url:h.OPERATION_LOGS_URL,method:"POST",data:{operation_type:t,operator:"admin",target_appointment_id:a,new_status:n,details:`\u66f4\u65b0\u9884\u7ea6\u72b6\u6001\u4e3a: ${n}`}}),l({title:c("management.updateSuccess"),icon:"success"}),R()):l({title:e.data.message||c("management.updateFailed"),icon:"error"})}catch(e){l({title:c("management.networkError"),icon:"error"})}}),O=a=>e(void 0,null,function*(){try{const e=a.match(/^appointment:([a-f\d]{24})$/);if(!e)return void l({title:"\u65e0\u6548\u7684\u4e8c\u7ef4\u7801",icon:"error"});const n=e[1];yield A(n,"in_progress","scan_signin"),T(!1),P(!1)}catch(e){l({title:"\u5904\u7406\u626b\u7801\u7ed3\u679c\u5931\u8d25",icon:"error"})}}),U=()=>e(void 0,null,function*(){if(F.trim())try{const e=yield u({url:`${h.APPOINTMENT_BY_NO_URL}/${F.trim()}`,method:"GET"});e.data.success&&e.data.data?(yield A(e.data.data._id,"in_progress","manual_signin"),M(""),P(!1)):l({title:"\u672a\u627e\u5230\u5bf9\u5e94\u7684\u9884\u7ea6",icon:"error"})}catch(e){l({title:"\u7b7e\u5230\u5931\u8d25",icon:"error"})}else l({title:"\u8bf7\u8f93\u5165\u9884\u7ea6\u5355\u53f7",icon:"error"})}),Y=()=>{P(!0)},L=e=>{const a={pending:c("management.pending"),confirmed:c("management.confirmed"),in_progress:c("management.in_progress"),completed:c("management.completed"),cancelled:c("management.cancelled"),broken:c("management.broken")};return a[e]||e},q=e=>c(`petTypes.${e}`)||e,I=(e,a)=>{f(e),y(a)},B=()=>{C(!0)},G=(e,a)=>{S({startDate:e,endDate:a})},z=()=>{S({startDate:"",endDate:""})},V=()=>k.startDate&&k.endDate?`${k.startDate} \u81f3 ${k.endDate}`:c("management.selectDate");return a.jsxs(n,{className:"layout page-management",children:[a.jsx(x,{title:c("management.title"),showScanButton:!0,onScanClick:Y}),a.jsx(n,{className:"container",children:a.jsxs(n,{className:"content-container",children:[a.jsx(n,{className:"header",children:a.jsxs(n,{className:"filter-section",children:[a.jsxs(n,{className:"date-filter-container",children:[a.jsx(n,{className:"filter-picker",onClick:B,children:a.jsx(n,{className:"picker-value",children:V()})}),k.startDate&&k.endDate&&a.jsx(n,{className:"clear-date-btn",onClick:z,children:a.jsx(t,{className:"clear-date-text",children:"\xd7"})})]}),a.jsx(n,{className:"filter-status-bar",children:r.map((e,s)=>a.jsx(n,{className:"status-item card "+(_===s?"active":""),onClick:()=>I(e,s),children:a.jsx(t,{className:"status-text",children:e.label})},e.value))})]})}),a.jsx(o,{className:"appointment-list",scrollY:!0,children:d.map(e=>a.jsxs(n,{className:"appointment-card card",children:[a.jsxs(n,{className:"card-header",children:[a.jsxs(n,{className:"header-top",children:[a.jsxs(t,{className:"appointment-no",children:["#",e.appointment_no]}),a.jsx(n,{className:`status-badge ${e.status}`,children:L(e.status)})]}),a.jsx(t,{className:"service-name",children:e.service_name})]}),a.jsxs(n,{className:"card-content",children:[a.jsxs(n,{className:"info-row",children:[a.jsxs(t,{className:"label",children:[c("management.customer"),":"]}),a.jsx(t,{className:"value",children:e.customer_name})]}),a.jsxs(n,{className:"info-row",children:[a.jsxs(t,{className:"label",children:[c("management.phone"),":"]}),a.jsx(t,{className:"value",children:e.customer_phone})]}),a.jsxs(n,{className:"info-row",children:[a.jsxs(t,{className:"label",children:[c("management.pet"),":"]}),a.jsxs(t,{className:"value",children:[q(e.pet_type)," \xb7",e.pet_breed||c("common.unknown")," \xb7",e.pet_size]})]}),a.jsxs(n,{className:"info-row",children:[a.jsxs(t,{className:"label",children:[c("management.time"),":"]}),a.jsxs(t,{className:"value",children:[g(new Date(e.appointment_date))," ",e.appointment_time]})]}),e.special_notes&&a.jsxs(n,{className:"info-row",children:[a.jsxs(t,{className:"label",children:[c("management.notes"),":"]}),a.jsx(t,{className:"value notes",children:e.special_notes})]})]}),a.jsxs(n,{className:"card-actions",children:["pending"===e.status&&a.jsx(s,{onClick:()=>A(e._id,"confirmed"),className:"action-btn confirm",children:c("management.confirm")}),"confirmed"===e.status&&a.jsxs(a.Fragment,{children:[a.jsx(s,{onClick:()=>A(e._id,"in_progress"),className:"action-btn start-service",children:c("management.start_service")}),a.jsx(s,{onClick:()=>A(e._id,"broken"),className:"action-btn no-show",children:c("management.mark_broken")})]}),"in_progress"===e.status&&a.jsx(s,{onClick:()=>A(e._id,"completed"),className:"action-btn complete",children:c("management.complete")}),"cancelled"!==e.status&&"completed"!==e.status&&"broken"!==e.status&&a.jsx(s,{onClick:()=>A(e._id,"cancelled"),className:"action-btn cancel",children:c("management.cancel")})]})]},e._id))}),v&&a.jsx(n,{className:"loading",children:a.jsx(t,{children:c("common.loading")})}),!v&&0===d.length&&a.jsx(n,{className:"empty",children:a.jsx(t,{children:c("management.noData")})})]})}),$&&a.jsx(j,{onScanSuccess:O,onClose:()=>T(!1)}),E&&a.jsx(n,{className:"modal-overlay",children:a.jsxs(n,{className:"modal-content",children:[a.jsx(t,{className:"modal-title",children:"\u7b7e\u5230\u65b9\u5f0f"}),a.jsxs(n,{className:"modal-actions",children:[a.jsx(s,{className:"modal-btn scan-btn",onClick:()=>{P(!1),T(!0)},children:"\ud83d\udcf7 \u626b\u7801\u7b7e\u5230"}),a.jsx(s,{className:"modal-btn manual-btn",onClick:U,children:"\ud83d\udd22 \u5355\u53f7\u7b7e\u5230"}),a.jsx(s,{className:"modal-btn cancel-btn",onClick:()=>P(!1),children:"\u53d6\u6d88"})]}),a.jsxs(n,{className:"manual-input-section",children:[a.jsx(t,{className:"input-label",children:"\u9884\u7ea6\u5355\u53f7\uff1a"}),a.jsx("input",{type:"text",className:"manual-input",value:F,onChange:e=>M(e.target.value),placeholder:"\u8bf7\u8f93\u5165\u9884\u7ea6\u5355\u53f7"})]})]})}),a.jsx(p,{visible:w,onClose:()=>C(!1),onConfirm:G,initialStartDate:k.startDate,initialEndDate:k.endDate})]})},v=d(N);export{v as default};
